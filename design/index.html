<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="styles.css"/>
        <link rel="stylesheet" href="design-page-styles.css"/>
        <script src="custom-question.js"></script>
        <script src="click-handlers.js"></script>
        <script type="text/javascript" src="design-page-components.js"></script>
    </head>
    <body>
        <div class="node-properties__key-properties">
            <div class="comd-panel node-property node-properties-key-fields node-property--progress">
                <header class="node-properties__header co-flex co-flex--justify-between co-flex--center">
                    <div class="node-properties__toggle co-flex co-flex--center">
                        <h4 class="co-text-size-normal">Encouragement progress bar</h4>
                        <div class="sd-tooltip-help" data-tooltip-text="Show a bar with messages and colored backgrounds controlled by character count, to encourage your respondents to provide more detail."></div>
                    </div>
                    <div class="co-flex co-flex--center">
                        <button class="collapse-button comd-icon-button comd-panel__toggle--icon-button"></button>
                    </div>
                </header>
                <div class="comd-panel__collapse-area node-property__content node-property__content--progress">
                    <div class="setting-row">
                        <div class="co-toggle co-toggle--checkbox">
                            <input class="co-toggle__input node-property__checkbox" type="checkbox" id="pbEnabled"/>
                            <label for="pbEnabled" class="node-property__label node-property__label--checkbox">
                                <div class="icon icon-checkbox co-icon">
                                </div>
                                <span>Enabled</span>
                            </label>
                        </div>
                    </div>
                    <div class="setting-col node-property__sub-content hidden">
                        <div class="setting-row">
                            <div class="setting-col progress__height">
                                <label class="node-property__label" for="pbHeight">Height</label>
                                <div class="setting-row">
                                    <input class="form-control input-sm form-input" type="text" id="pbHeight" value="5"/>
                                    <span class="node-property__after node-property__after--progress" for="pbHeight">px</span>
                                </div>
                            </div>
                            <div class="setting-col progress__prompt">
                                <label class="node-property__label" for="pbPosition">Prompt position <div class="sd-tooltip-help" data-tooltip-text="Display the encouragement texts above, within or below the bar. Note that the text will only be displayed within the bar if the bar height is 15px or larger."></div></label>
                                <select class="form-control form-input" id="pbPosition" name="pbPosition">
                                    <option value="1" selected="selected">Above the bar</option>
                                    <option value="2">Inside the bar</option>
                                    <option value="3">Below the bar</option>
                                </select>
                            </div>
                        </div>
                        <div class="setting-col">
                            <div class="setting-row value__option-table">
                                <label class="node-property__label value__option-header value__option-header--min">Min value <div class="sd-tooltip-help" data-tooltip-text="The character count threshold for change of color and text."></div></label>
                                <label class="node-property__label value__option-header value__option-header--color">Color <div class="sd-tooltip-help" data-tooltip-text="The color to be displayed in the bar once the minimum value is reached."></div></label>
                                <label class="node-property__label value__option-header value__option-header--text">Encouragement text <div class="sd-tooltip-help" data-tooltip-text="The text to be displayed to the respondent once the minimum value is reached."></div></label>
                            </div>
                            <div class="setting-row value__option-table">
                                <div class="value__option-input value__option-input--min"><input class="form-control form-input" name="pbStartValue" type="number" value="1" /></div>
                                <div class="value__option-input value__option-input--color"><input class="form-control form-input form-input--color" type="color" name="pbColor" value="#ff0000"/></div>
                                <div class="value__option-input value__option-input--text"><input class="form-control form-input" name="pbPrompt" type="text" value="Good start"/></div>
                            </div>
                            <div class="setting-row value__option-table">
                                <div class="value__option-input value__option-input--min"><input class="form-control form-input" name="pbStartValue" type="number" value="15" /></div>
                                <div class="value__option-input value__option-input--color"><input class="form-control form-input form-input--color" type="color" name="pbColor" value="#ffff00"/></div>
                                <div class="value__option-input value__option-input--text"><input class="form-control form-input" name="pbPrompt" type="text" value="A little more information would be appreciated"/></div>
                            </div>
                            <div class="setting-row value__option-table">
                                <div class="value__option-input value__option-input--min"><input class="form-control form-input" name="pbStartValue" type="number" value="30" /></div>
                                <div class="value__option-input value__option-input--color"><input class="form-control form-input form-input--color" type="color" name="pbColor" value="#00ff00"/></div>
                                <div class="value__option-input value__option-input--text"><input class="form-control form-input" name="pbPrompt" type="text" value="Fantastic! Many thanks for your feedback"/></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="comd-panel node-property node-properties-key-fields node-property--count">
                <header class="node-properties__header co-flex co-flex--justify-between co-flex--center">
                    <div class="node-properties__toggle co-flex co-flex--center">
                        <h4 class="co-text-size-normal">Character count</h4>
                        <div class="sd-tooltip-help" data-tooltip-text="Show the number of characters entered by your respondent. You can also show Character limit beside counter."></div>
                    </div>
                    <div class="co-flex co-flex--center">
                        <button class="collapse-button comd-icon-button comd-panel__toggle--icon-button"></button>
                    </div>
                </header>
                <div class="comd-panel__collapse-area node-property__content node-property__content--count">
                    <div class="setting-row">
                        <div class="co-toggle co-toggle--checkbox">
                            <input class="co-toggle__input node-property__checkbox" type="checkbox" id="countEnabled"/>
                            <label for="countEnabled" class="node-property__label node-property__label--checkbox">
                                <div class="icon icon-checkbox co-icon">
                                </div>
                                <span>Enabled</span>
                            </label>
                        </div>
                    </div>
                    <div class="setting-col node-property__sub-content hidden">
                        <div class="setting-row">
                            <div class="comd-alert comd-alert--info">
                                <div class="comd-alert__text">
                                    Please make sure Character limit corresponds to the question settings.
                                </div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="co-toggle co-toggle--checkbox">
                                <input class="co-toggle__input node-property__checkbox" type="checkbox" id="showCharacterLimit"/>
                                <label for="showCharacterLimit" class="node-property__label node-property__label--checkbox">
                                    <div class="icon icon-checkbox co-icon">
                                    </div>
                                    <span>Show Character limit beside counter (if it's set)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="comd-panel node-property node-properties-key-fields node-property--keyword">
                <header class="node-properties__header co-flex co-flex--justify-between co-flex--center">
                    <div class="node-properties__toggle co-flex co-flex--center">
                        <h4 class="co-text-size-normal">Keywords</h4>
                        <div class="sd-tooltip-help" data-tooltip-text="Add prompts and encouragements to the question, triggered by keywords, that will hopefully elicit more detail in the response."></div>
                    </div>
                    <div class="co-flex co-flex--center">
                        <button class="collapse-button comd-icon-button comd-panel__toggle--icon-button"></button>
                    </div>
                </header>
                <div class="comd-panel__collapse-area node-property__content node-property__content--keyword">
                    <div class="setting-row">
                        <div class="co-toggle co-toggle--checkbox">
                            <input class="co-toggle__input node-property__checkbox" type="checkbox" id="keywordEnabled"/>
                            <label for="keywordEnabled" class="node-property__label node-property__label--checkbox">
                                <div class="icon icon-checkbox co-icon">
                                </div>
                                <span>Enabled</span>
                            </label>
                        </div>
                    </div>
                    <div class="setting-col node-property__sub-content hidden">
                        <div class="setting-col">
                            <div class="setting-row keyword__option-table">
                                <div class="node-property__label value__option-header keyword__option-header--word">Keywords<div class="sd-tooltip-help" data-tooltip-text="Enter a comma-separated list of keywords which, if used by the respondent, will trigger the prompt text."></div></div>
                                <div class="node-property__label value__option-header keyword__option-header--text">Prompt text<div class="sd-tooltip-help" data-tooltip-text="Add text which will be displayed when a trigger word is entered, to encourage the respondent to include more detail in their response."></div></div>
                            </div>
                            <div class="setting-col keyword__options">
                                <div class="setting-row keywords__option-table">
                                    <div class="value__option-input keyword__option-input--word"><input class="form-control form-input" name="keyword" type="text" /></div>
                                    <div class="value__option-input keyword__option-input--text"><input class="form-control form-input" name="keywordPrompt" type="text" /></div>
                                </div>
                                <div class="setting-row keyword__option-table">
                                    <div class="value__option-input keyword__option-input--word"><input class="form-control form-input" name="keyword" type="text" /></div>
                                    <div class="value__option-input keyword__option-input--text"><input class="form-control form-input" name="keywordPrompt" type="text" /></div>
                                </div>
                                <div class="setting-row keyword__option-table">
                                    <div class="value__option-input keyword__option-input--word"><input class="form-control form-input" name="keyword" type="text" /></div>
                                    <div class="value__option-input keyword__option-input--text"><input class="form-control form-input" name="keywordPrompt" type="text" /></div>
                                </div>
                            </div>
                            <div class="setting-row">
                                <div class="node-property button-block keyword__button--add">
                                    <div class="button-block">
                                        <button class="comd-button comd-button--secondary-neutral">
                                            <span class="comd-button__content">
                                                <div class="comd-portal-trigger">+ Add row</div>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="comd-tooltip comd-tooltip--right" id="tooltipBox">
            <div class="comd-tooltip__arrow"></div>
            <div class="comd-tooltip__inner"></div>
        </div>
        <script>
            var pbEnabled = document.getElementById('pbEnabled');
            var pbHeightInput = document.getElementById('pbHeight');
            var pbPositionSelector = document.getElementById('pbPosition');
            var pbMinInputs = Array.prototype.slice.call(document.querySelectorAll('.value__option-input--min input'));
            var pbColorInputs = Array.prototype.slice.call(document.querySelectorAll('.value__option-input--color input'));
            var pbPromptInputs = Array.prototype.slice.call(document.querySelectorAll('.value__option-input--text input'));

            var countEnabled = document.getElementById('countEnabled');
            //var characterLimit = document.getElementById('characterLimit');
            var showCharacterLimit = document.getElementById('showCharacterLimit');

            var keywordEnabled = document.getElementById('keywordEnabled');
            var starterKeywordWordInputs = Array.prototype.slice.call(document.querySelectorAll('.keyword__option-input--word input'));
            var starterKeywordPromptInputs = Array.prototype.slice.call(document.querySelectorAll('.keyword__option-input--text input'));
            
            let currentLanguage = '';

            let pbPromptsObj = {};
            let keywordWordsObj = {};
            let keywordPromptsObj = {};

            function setValues(settings, uiSettings) {

                currentLanguage = String(uiSettings.currentLanguage);
                if (!settings) return;

                pbEnabled.checked = settings.pbEnabled;
                countEnabled.checked = settings.countEnabled;
                keywordEnabled.checked = settings.keywordEnabled;

                hideSubsectionAfterBoxChecked(pbEnabled);
                hideSubsectionAfterBoxChecked(countEnabled);
                hideSubsectionAfterBoxChecked(keywordEnabled);

                pbHeightInput.value = settings.pbHeight;
                pbPositionSelector.value = settings.pbPosition;

                var pbMinValues = settings.pbMinValues;
                var pbColors = settings.pbColors;
                if(settings.hasOwnProperty('pbPrompts')) {
                    pbPromptsObj = settings.pbPrompts;
                }

                if(settings.hasOwnProperty('pbPrompts') && settings.pbPrompts[currentLanguage] !== undefined) {
                    for(var i = 0; i < pbMinValues.length; i++) {
                        pbPromptInputs[i].value = settings.pbPrompts[currentLanguage][i];
                    }
                } else {
                    for(var i = 0; i < pbMinValues.length; i++) {
                        pbPromptInputs[i].value = '';
                    }
                }

                for(var i = 0; i < pbMinValues.length; i++) {
                    pbMinInputs[i].value = pbMinValues[i];
                    pbColorInputs[i].value = pbColors[i];
                }

                //characterLimit.value = settings.characterLimit;
                showCharacterLimit.checked = settings.showCharacterLimit;

                var keywordWords = [];
                var keywordPrompts = [];

                if(settings.hasOwnProperty('keywordWords')) {
                    keywordWordsObj = settings.keywordWords;
                }
                if(settings.hasOwnProperty('keywordPrompts')) {
                    keywordPromptsObj = settings.keywordPrompts;
                }

                if(settings.hasOwnProperty('keywordWords') && settings.keywordWords[currentLanguage] !== undefined) {
                    keywordWords = settings.keywordWords[currentLanguage];
                }
                if(settings.hasOwnProperty('keywordPrompts') && settings.keywordPrompts[currentLanguage] !== undefined) {
                    keywordPrompts = settings.keywordPrompts[currentLanguage];
                }

                if(starterKeywordWordInputs.length === 3 && keywordWords.length > starterKeywordWordInputs.length) {
                    var newRowsToAdd = keywordWords.length - starterKeywordWordInputs.length;
                    for(var k = 0; k < newRowsToAdd; k++) {
                        addKeywordsRow();
                    }
                }
                starterKeywordWordInputs = Array.prototype.slice.call(document.querySelectorAll('.keyword__option-input--word input'));
                starterKeywordPromptInputs = Array.prototype.slice.call(document.querySelectorAll('.keyword__option-input--text input'));

                for(var j = 0; j < starterKeywordWordInputs.length; j++) {
                    starterKeywordWordInputs[j].value = '';
                    starterKeywordPromptInputs[j].value = '';
                }

                for(var j = 0; j < keywordWords.length; j++) {
                    starterKeywordWordInputs[j].value = keywordWords[j];
                    starterKeywordPromptInputs[j].value = keywordPrompts[j];
                }
            }

            function saveChanges() {
                var pbMinValues = [];
                var pbColors = [];
                var pbPrompts = [];

                for(var i = 0; i < pbMinInputs.length; i++) {
                    pbMinValues.push(parseInt(pbMinInputs[i].value));
                    pbColors.push(pbColorInputs[i].value);
                    pbPrompts.push(pbPromptInputs[i].value);
                }

                pbPromptsObj[currentLanguage] = pbPrompts;

                var keywordWords = [];
                var keywordPrompts = [];

                var keywordWordInputs = Array.prototype.slice.call(document.querySelectorAll('.keyword__option-input--word input'));
                var keywordPromptInputs = Array.prototype.slice.call(document.querySelectorAll('.keyword__option-input--text input'));

                for(var j = 0; j < keywordWordInputs.length; j++) {
                    if(keywordWordInputs[j].value !== "" && keywordPromptInputs[j].value !== "") {
                        keywordWords.push(keywordWordInputs[j].value);
                        keywordPrompts.push(keywordPromptInputs[j].value);
                    }
                }

                keywordWordsObj[currentLanguage] = keywordWords;
                keywordPromptsObj[currentLanguage] = keywordPrompts;

                var settings = { pbEnabled: pbEnabled.checked,
                                 pbHeight: parseInt(pbHeightInput.value),
                                 pbPosition: pbPositionSelector.options[pbPositionSelector.selectedIndex].value,
                                 pbMinValues: pbMinValues,
                                 pbColors: pbColors,
                                 pbPrompts: pbPromptsObj,
                                 countEnabled: countEnabled.checked,
                                 //characterLimit: parseInt(characterLimit.value),
                                 showCharacterLimit: showCharacterLimit.checked,
                                 keywordEnabled: keywordEnabled.checked,
                                 keywordWords: keywordWordsObj,
                                 keywordPrompts: keywordPromptsObj
                };

                var hasError = false;
                customQuestion.saveChanges(settings, hasError);
            }

            customQuestion.onSettingsReceived = setValues;

            var containers = Array.prototype.slice.call(document.querySelectorAll(".comd-panel"));
            for (var c = 0; c < containers.length; c++) {
                containers[c].addEventListener('input', saveChanges, true);
            }

            pbPositionSelector.addEventListener('change', saveChanges, true);
            pbEnabled.addEventListener('change', saveChanges, true);
            countEnabled.addEventListener('change', saveChanges, true);
            showCharacterLimit.addEventListener('change', saveChanges, true);
            keywordEnabled.addEventListener('change', saveChanges, true);

        </script>
    </body>
</html>

